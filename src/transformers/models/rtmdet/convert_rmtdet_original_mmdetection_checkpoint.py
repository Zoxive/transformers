import torch

from transformers import RTMDetCSPNeXtConfig, RTMDetCSPNeXtBackbone


def main(model_name: str = "cspnext_tiny_imagenet_600e"):

    model_name_to_checkpoint_url = {
        # backbone
        "cspnext_tiny_imagenet_600e": "https://download.openmmlab.com/mmdetection/v3.0/rtmdet/cspnext_rsb_pretrain/cspnext-tiny_imagenet_600e.pth"
    }

    state_dict = torch.hub.load_state_dict_from_url(model_name_to_checkpoint_url[model_name], map_location='cpu')
    print(state_dict.keys())
    #['meta', 'state_dict', 'optimizer']

    meta = state_dict['meta']
    # dict_keys(['env_info', 'seed', 'mmcls_version', 'config', 'CLASSES', 'hook_msgs', 'epoch', 'iter', 'mmcv_version', 'time'])
    
    prefix = 'backbone.'
    state_dict_inner = state_dict['state_dict']
    # dict_keys(['backbone.stem.0.conv.weight', 'backbone.stem.0.bn.weight', 'backbone.stem.0.bn.bias', 'backbone.stem.0.bn.running_mean', 'backbone.stem.0.bn.running_var', 'backbone.stem.0.bn.num_batches_tracked', 'backbone.stem.1.conv.weight', 'backbone.stem.1.bn.weight', 'backbone.stem.1.bn.bias', 'backbone.stem.1.bn.running_mean', 'backbone.stem.1.bn.running_var', 'backbone.stem.1.bn.num_batches_tracked', 'backbone.stem.2.conv.weight', 'backbone.stem.2.bn.weight', 'backbone.stem.2.bn.bias', 'backbone.stem.2.bn.running_mean', 'backbone.stem.2.bn.running_var', 'backbone.stem.2.bn.num_batches_tracked', 'backbone.stage1.0.conv.weight', 'backbone.stage1.0.bn.weight', 'backbone.stage1.0.bn.bias', 'backbone.stage1.0.bn.running_mean', 'backbone.stage1.0.bn.running_var', 'backbone.stage1.0.bn.num_batches_tracked', 'backbone.stage1.1.main_conv.conv.weight', 'backbone.stage1.1.main_conv.bn.weight', 'backbone.stage1.1.main_conv.bn.bias', 'backbone.stage1.1.main_conv.bn.running_mean', 'backbone.stage1.1.main_conv.bn.running_var', 'backbone.stage1.1.main_conv.bn.num_batches_tracked', 'backbone.stage1.1.short_conv.conv.weight', 'backbone.stage1.1.short_conv.bn.weight', 'backbone.stage1.1.short_conv.bn.bias', 'backbone.stage1.1.short_conv.bn.running_mean', 'backbone.stage1.1.short_conv.bn.running_var', 'backbone.stage1.1.short_conv.bn.num_batches_tracked', 'backbone.stage1.1.final_conv.conv.weight', 'backbone.stage1.1.final_conv.bn.weight', 'backbone.stage1.1.final_conv.bn.bias', 'backbone.stage1.1.final_conv.bn.running_mean', 'backbone.stage1.1.final_conv.bn.running_var', 'backbone.stage1.1.final_conv.bn.num_batches_tracked', 'backbone.stage1.1.blocks.0.conv1.conv.weight', 'backbone.stage1.1.blocks.0.conv1.bn.weight', 'backbone.stage1.1.blocks.0.conv1.bn.bias', 'backbone.stage1.1.blocks.0.conv1.bn.running_mean', 'backbone.stage1.1.blocks.0.conv1.bn.running_var', 'backbone.stage1.1.blocks.0.conv1.bn.num_batches_tracked', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.conv.weight', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.bn.weight', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.bn.bias', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.bn.running_mean', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.bn.running_var', 'backbone.stage1.1.blocks.0.conv2.depthwise_conv.bn.num_batches_tracked', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.conv.weight', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.bn.weight', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.bn.bias', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.bn.running_mean', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.bn.running_var', 'backbone.stage1.1.blocks.0.conv2.pointwise_conv.bn.num_batches_tracked', 'backbone.stage1.1.attention.fc.weight', 'backbone.stage1.1.attention.fc.bias', 'backbone.stage2.0.conv.weight', 'backbone.stage2.0.bn.weight', 'backbone.stage2.0.bn.bias', 'backbone.stage2.0.bn.running_mean', 'backbone.stage2.0.bn.running_var', 'backbone.stage2.0.bn.num_batches_tracked', 'backbone.stage2.1.main_conv.conv.weight', 'backbone.stage2.1.main_conv.bn.weight', 'backbone.stage2.1.main_conv.bn.bias', 'backbone.stage2.1.main_conv.bn.running_mean', 'backbone.stage2.1.main_conv.bn.running_var', 'backbone.stage2.1.main_conv.bn.num_batches_tracked', 'backbone.stage2.1.short_conv.conv.weight', 'backbone.stage2.1.short_conv.bn.weight', 'backbone.stage2.1.short_conv.bn.bias', 'backbone.stage2.1.short_conv.bn.running_mean', 'backbone.stage2.1.short_conv.bn.running_var', 'backbone.stage2.1.short_conv.bn.num_batches_tracked', 'backbone.stage2.1.final_conv.conv.weight', 'backbone.stage2.1.final_conv.bn.weight', 'backbone.stage2.1.final_conv.bn.bias', 'backbone.stage2.1.final_conv.bn.running_mean', 'backbone.stage2.1.final_conv.bn.running_var', 'backbone.stage2.1.final_conv.bn.num_batches_tracked', 'backbone.stage2.1.blocks.0.conv1.conv.weight', 'backbone.stage2.1.blocks.0.conv1.bn.weight', 'backbone.stage2.1.blocks.0.conv1.bn.bias', 'backbone.stage2.1.blocks.0.conv1.bn.running_mean', 'backbone.stage2.1.blocks.0.conv1.bn.running_var', 'backbone.stage2.1.blocks.0.conv1.bn.num_batches_tracked', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.conv.weight', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.bn.weight', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.bn.bias', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.bn.running_mean', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.bn.running_var', 'backbone.stage2.1.blocks.0.conv2.depthwise_conv.bn.num_batches_tracked', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.conv.weight', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.bn.weight', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.bn.bias', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.bn.running_mean', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.bn.running_var', 'backbone.stage2.1.blocks.0.conv2.pointwise_conv.bn.num_batches_tracked', 'backbone.stage2.1.attention.fc.weight', 'backbone.stage2.1.attention.fc.bias', 'backbone.stage3.0.conv.weight', 'backbone.stage3.0.bn.weight', 'backbone.stage3.0.bn.bias', 'backbone.stage3.0.bn.running_mean', 'backbone.stage3.0.bn.running_var', 'backbone.stage3.0.bn.num_batches_tracked', 'backbone.stage3.1.main_conv.conv.weight', 'backbone.stage3.1.main_conv.bn.weight', 'backbone.stage3.1.main_conv.bn.bias', 'backbone.stage3.1.main_conv.bn.running_mean', 'backbone.stage3.1.main_conv.bn.running_var', 'backbone.stage3.1.main_conv.bn.num_batches_tracked', 'backbone.stage3.1.short_conv.conv.weight', 'backbone.stage3.1.short_conv.bn.weight', 'backbone.stage3.1.short_conv.bn.bias', 'backbone.stage3.1.short_conv.bn.running_mean', 'backbone.stage3.1.short_conv.bn.running_var', 'backbone.stage3.1.short_conv.bn.num_batches_tracked', 'backbone.stage3.1.final_conv.conv.weight', 'backbone.stage3.1.final_conv.bn.weight', 'backbone.stage3.1.final_conv.bn.bias', 'backbone.stage3.1.final_conv.bn.running_mean', 'backbone.stage3.1.final_conv.bn.running_var', 'backbone.stage3.1.final_conv.bn.num_batches_tracked', 'backbone.stage3.1.blocks.0.conv1.conv.weight', 'backbone.stage3.1.blocks.0.conv1.bn.weight', 'backbone.stage3.1.blocks.0.conv1.bn.bias', 'backbone.stage3.1.blocks.0.conv1.bn.running_mean', 'backbone.stage3.1.blocks.0.conv1.bn.running_var', 'backbone.stage3.1.blocks.0.conv1.bn.num_batches_tracked', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.conv.weight', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.bn.weight', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.bn.bias', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.bn.running_mean', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.bn.running_var', 'backbone.stage3.1.blocks.0.conv2.depthwise_conv.bn.num_batches_tracked', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.conv.weight', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.bn.weight', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.bn.bias', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.bn.running_mean', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.bn.running_var', 'backbone.stage3.1.blocks.0.conv2.pointwise_conv.bn.num_batches_tracked', 'backbone.stage3.1.attention.fc.weight', 'backbone.stage3.1.attention.fc.bias', 'backbone.stage4.0.conv.weight', 'backbone.stage4.0.bn.weight', 'backbone.stage4.0.bn.bias', 'backbone.stage4.0.bn.running_mean', 'backbone.stage4.0.bn.running_var', 'backbone.stage4.0.bn.num_batches_tracked', 'backbone.stage4.1.conv1.conv.weight', 'backbone.stage4.1.conv1.bn.weight', 'backbone.stage4.1.conv1.bn.bias', 'backbone.stage4.1.conv1.bn.running_mean', 'backbone.stage4.1.conv1.bn.running_var', 'backbone.stage4.1.conv1.bn.num_batches_tracked', 'backbone.stage4.1.conv2.conv.weight', 'backbone.stage4.1.conv2.bn.weight', 'backbone.stage4.1.conv2.bn.bias', 'backbone.stage4.1.conv2.bn.running_mean', 'backbone.stage4.1.conv2.bn.running_var', 'backbone.stage4.1.conv2.bn.num_batches_tracked', 'backbone.stage4.2.main_conv.conv.weight', 'backbone.stage4.2.main_conv.bn.weight', 'backbone.stage4.2.main_conv.bn.bias', 'backbone.stage4.2.main_conv.bn.running_mean', 'backbone.stage4.2.main_conv.bn.running_var', 'backbone.stage4.2.main_conv.bn.num_batches_tracked', 'backbone.stage4.2.short_conv.conv.weight', 'backbone.stage4.2.short_conv.bn.weight', 'backbone.stage4.2.short_conv.bn.bias', 'backbone.stage4.2.short_conv.bn.running_mean', 'backbone.stage4.2.short_conv.bn.running_var', 'backbone.stage4.2.short_conv.bn.num_batches_tracked', 'backbone.stage4.2.final_conv.conv.weight', 'backbone.stage4.2.final_conv.bn.weight', 'backbone.stage4.2.final_conv.bn.bias', 'backbone.stage4.2.final_conv.bn.running_mean', 'backbone.stage4.2.final_conv.bn.running_var', 'backbone.stage4.2.final_conv.bn.num_batches_tracked', 'backbone.stage4.2.blocks.0.conv1.conv.weight', 'backbone.stage4.2.blocks.0.conv1.bn.weight', 'backbone.stage4.2.blocks.0.conv1.bn.bias', 'backbone.stage4.2.blocks.0.conv1.bn.running_mean', 'backbone.stage4.2.blocks.0.conv1.bn.running_var', 'backbone.stage4.2.blocks.0.conv1.bn.num_batches_tracked', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.conv.weight', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.bn.weight', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.bn.bias', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.bn.running_mean', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.bn.running_var', 'backbone.stage4.2.blocks.0.conv2.depthwise_conv.bn.num_batches_tracked', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.conv.weight', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.bn.weight', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.bn.bias', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.bn.running_mean', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.bn.running_var', 'backbone.stage4.2.blocks.0.conv2.pointwise_conv.bn.num_batches_tracked', 'backbone.stage4.2.attention.fc.weight', 'backbone.stage4.2.attention.fc.bias', 'head.fc.weight', 'head.fc.bias'])
    
    optimizer = state_dict['optimizer']
    # dict_keys(['state', 'param_groups'])

    # remove prefix from keys
    renamed_state_dict = dict()
    for k in list(state_dict_inner.keys()):
        if k.startswith(prefix):
            renamed_state_dict[k[len(prefix):]] = state_dict_inner[k]

    model = RTMDetCSPNeXtBackbone(RTMDetCSPNeXtConfig())
    model.load_state_dict(renamed_state_dict)
    model.eval()

if __name__ == '__main__':
    main()
    
